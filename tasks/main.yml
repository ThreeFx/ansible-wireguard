---
- name: Install wireguard (Debian)
  become: True
  apt:
    package:
      - wireguard
      - linux-image-amd64
    default_release: "{{ wireguard_apt_release }}"
  when: ansible_os_family == 'Debian'

- name: Install wireguard (non-Debian)
  become: True
  package:
    name:
      - wireguard
  when: not (ansible_os_family == 'Debian')

- name: Configure wireguard tunnels
  become: True
  template:
    src: wg.j2
    dest: "/etc/wireguard/{{ item.name }}.conf"
    mode: 0600
    owner: root
    group: root
  with_items: "{{ wireguard_configurations }}"
  register: wireguard_configurations_results
  notify: restart wireguard tunnels
